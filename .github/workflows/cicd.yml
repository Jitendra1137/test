name: Build & Deploy to EC2

on:
  push:
    branches: ["main"]
  release:
    types: [published]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------
      # 1) Checkout Code
      # ------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------------------------
      # 2) Generate TAG (version)
      # ------------------------------------
      - name: Set TAG
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
          else
            SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
            echo "TAG=${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> $GITHUB_ENV
          fi

      # ------------------------------------
      # 3) Create Frontent ENV File
      # ------------------------------------
      - name: Create Frontent ENV File
        run: |
          echo "VITE_API_BASE=${{ secrets.VITE_API_BASE }}" > frontent/.env.production
          echo "VITE_GEMINI_API_KEY=${{ secrets.VITE_GEMINI_API_KEY }}" >> frontent/.env.production
          echo "VITE_FRONTEND_URL=${{ secrets.VITE_FRONTEND_URL }}" >> frontent/.env.production

          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}" >> frontent/.env.production
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" >> frontent/.env.production
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" >> frontent/.env.production
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" >> frontent/.env.production
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}" >> frontent/.env.production
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}" >> frontent/.env.production

      # ------------------------------------
      # 4) DockerHub Login
      # ------------------------------------
      - name: Login to DockerHub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "jitendrajat" --password-stdin

      # ------------------------------------
      # 5) Build Backend Image
      # ------------------------------------
      - name: Build Backend Image
        run: docker build -t jitendrajat/backend:${{ env.TAG }} ./backend

      # ------------------------------------
      # 6) Build Frontent Image
      # ------------------------------------
      - name: Build Frontent Image
        run: docker build -t jitendrajat/frontent:${{ env.TAG }} ./frontent

      # ------------------------------------
      # 7) Push Images
      # ------------------------------------
      - name: Push Docker Images
        run: |
          docker push jitendrajat/backend:${{ env.TAG }}
          docker push jitendrajat/frontent:${{ env.TAG }}
          docker logout

      # ------------------------------------
      # 8) SSH Setup
      # ------------------------------------
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ------------------------------------
      # 9) DEPLOY ON EC2 (WITH ROLLBACK SAFE CLEANUP)
      # ------------------------------------
      - name: Deploy to EC2 with Cleanup + Rollback Support
        env:
          TAG: ${{ env.TAG }}
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} << EOF
            echo "ðŸš€ Deployment Started"

            cd /home/ubuntu/clurst.io

            echo "ðŸ§¹ Removing existing containers..."
            docker rm -f \$(docker ps -aq) || true

            echo "ðŸ§¹ Removing OLD IMAGES (keeping last 3 only)..."
            docker images "jitendrajat/*" --format "{{.Repository}}:{{.Tag}}" | \
            sort -r | sed -e '1,3d' | xargs -r docker rmi -f || true

            echo "ðŸ”„ Updating TAGS in .env"
            sed -i "s|BACKEND_TAG=.*|BACKEND_TAG=${TAG}|" .env || echo "BACKEND_TAG=${TAG}" >> .env
            sed -i "s|FRONTENT_TAG=.*|FRONTENT_TAG=${TAG}|" .env || echo "FRONTENT_TAG=${TAG}" >> .env

            echo "ðŸ“¥ Pulling latest images..."
            docker-compose pull

            echo "ðŸš€ Starting fresh containers..."
            docker-compose up -d

            echo "ðŸŽ‰ Deployment SUCCESS | Rollback-Safe Clean System"

