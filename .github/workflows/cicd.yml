name: Build & Deploy to EC2

on:
  push:
    branches: ["main"]
  release:
    types: [published]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------
    # 1) Checkout Code
    # ------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4


    # ------------------------------
    # 2) Generate Tag (latest build ID)
    # ------------------------------
    - name: Set TAG
      id: vars
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
        else
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "TAG=${GITHUB_RUN_NUMBER}-${SHORT_SHA}" >> $GITHUB_ENV
        fi


    # ------------------------------
    # 3) Create Frontend ENV
    # ------------------------------
    - name: Create Frontend ENV (.env.production)
      run: |
        cat > frontend/.env.production <<EOF
VITE_API_BASE=${{ secrets.VITE_API_BASE }}
VITE_GEMINI_API_KEY=${{ secrets.VITE_GEMINI_API_KEY }}
VITE_FRONTEND_URL=${{ secrets.VITE_FRONTEND_URL }}

VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
EOF


    # ------------------------------
    # 4) DockerHub Login
    # ------------------------------
    - name: Login to DockerHub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin


    # ------------------------------
    # 5) Build Backend Image
    # ------------------------------
    - name: Build Backend Image
      run: docker build -t DOCKER_USERNAME/backend:${{ env.TAG }} ./backend


    # ------------------------------
    # 6) Build Frontend Image
    # ------------------------------
    - name: Build Frontend Image
      run: docker build -t DOCKER_USERNAME/frontend:${{ env.TAG }} ./frontend


    # ------------------------------
    # 7) Push Images to DockerHub
    # ------------------------------
    - name: Push Docker Images
      run: |
        docker push DOCKER_USERNAME/backend:${{ env.TAG }}
        docker push DOCKER_USERNAME/frontend:${{ env.TAG }}
        docker logout


    # ------------------------------
    # 8) Setup SSH for EC2
    # ------------------------------
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts


    # ------------------------------
    # 9) Deploy to EC2 (NO HEALTHCHECK)
    # ------------------------------
    - name: Deploy on EC2 (Update tags + Restart Docker)
      env:
        TAG: ${{ env.TAG }}
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} "
          cd /home/ubuntu/jeetu-app

          # Update backend & frontend image tags
          sed -i 's|BACKEND_TAG=.*|BACKEND_TAG=${TAG}|' .env || echo 'BACKEND_TAG=${TAG}' >> .env
          sed -i 's|FRONTEND_TAG=.*|FRONTEND_TAG=${TAG}|' .env || echo 'FRONTEND_TAG=${TAG}' >> .env

          # Pull new images & restart containers
          docker-compose pull
          docker-compose up -d

          echo 'ðŸŽ‰ Deployment completed successfully (NO HEALTHCHECK)'
        "
